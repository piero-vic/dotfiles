#!/usr/bin/env bash

# Requirements:
# calibredb https://github.com/kovidgoyal/calibre
# jq https://github.com/jqlang/jq
# rofi https://github.com/lbonn/rofi

set -e

LIBRARY_NAME="books"
CALIBRE_ENDPOINT="http://localhost:8090"

library="$HOME/$LIBRARY_NAME"
if pgrep -f "/usr/bin/calibre" >/dev/null; then
  library="$CALIBRE_ENDPOINT"
fi

books=$(
  calibredb list \
    --fields title,formats \
    --sort-by title \
    --ascending \
    --with-library="$library" \
    --for-machine |
    jq -r '.[] | "\(.id)\t\(.formats[0])\t\(.title)"'
)

selected=$(echo "$books" | cut -f3 | rofi -sync -dmenu -i -p "Books")

id=$(echo "$books" | awk -F'\t' -v title="$selected" '$3 == title { print $1; exit }')
format=$(echo "$books" | awk -F'\t' -v title="$selected" '$3 == title { print $2; exit }')

if [ "$library" == $CALIBRE_ENDPOINT ]; then
  # TODO: Find a way to open directly in zathura
  xdg-open "calibre://view-book/$LIBRARY_NAME/$id/$format" >/dev/null 2>&1 &
else
  xdg-open "$format" >/dev/null 2>&1 &
fi
