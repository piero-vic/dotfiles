#!/usr/bin/env bash

# Requirements:
# calibredb https://github.com/kovidgoyal/calibre
# fzf https://github.com/junegunn/fzf
# jq https://github.com/jqlang/jq

set -e

filename=$(
  calibredb list \
    --fields title,formats \
    --sort-by title \
    --ascending \
    --for-machine |
    jq -r '.[] | "\(.id)\t\(.formats[0])\t\(.title)"' |
    fzf-tmux -p80%,60% \
      --info='inline-right' \
      --reverse \
      --no-sort \
      --with-nth=3 \
      --delimiter='\t' \
      --border-label=' Books ' \
      --prompt='ó°‚¼ ' \
      --preview-window='right,50%,border-left' \
      --preview 'calibredb show_metadata {1}' |
    cut -f2
)

xdg-open "$filename" >/dev/null 2>&1 &
